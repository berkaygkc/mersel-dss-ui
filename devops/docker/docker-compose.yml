version: '3.8'

# Sign UI Docker Compose Configuration
# For quick start: docker-compose up -d

services:
  # Sign UI Service
  sign-ui:
    build:
      context: ../../
      dockerfile: devops/docker/Dockerfile
      args:
        # Kubernetes ortamına yapılacak olan build için boş bırakılmalı, yoksa Runtime ortamında public/config.js overwrite edilmesi bir işe yaramaz
        - VITE_SIGN_API_URL=${VITE_SIGN_API_URL:-} 
        - VITE_VERIFY_API_URL=${VITE_VERIFY_API_URL:-}
    container_name: sign-ui
    ports:
      - "3001:8080"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    # depends_on:
    #   - sign-api

  # Sign API Service (optional - can use external)
  sign-api:
    image: ${DOCKERHUB_USERNAME}/dss-signer-api-java:latest
    container_name: sign-api
    ports:
      - "8085:8085"
    environment:
      - SERVER_PORT=8085
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ../../resources/test-certs:/app/certs:ro
      - api-logs:/app/logs
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8085/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    profiles:
      - with-backend

  # Nginx Reverse Proxy (optional - for production)
  nginx-proxy:
    image: nginx:1.25-alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    networks:
      - app-network
    restart: unless-stopped
    profiles:
      - production
    depends_on:
      - sign-ui
    # Note: Runs as root to bind to ports 80/443

networks:
  app-network:
    driver: bridge

volumes:
  api-logs:


